<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SYST√àME DE SUIVI DES PALETTES</title>
    <style>
        /* ÿ£ŸÜÿ≥ÿÆ ŸÉŸÑ ÿßŸÑŸÄ Style ÿßŸÑŸÖŸàÿ¨ŸàÿØ ŸÖŸÜ ŸÖŸÑŸÅŸÉ ÿßŸÑÿ£ÿµŸÑŸä ŸáŸÜÿß */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f5f5; min-height: 100vh; padding: 0; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; background: linear-gradient(135deg, #2c3e50, #3498db); }
        .login-form { background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; max-width: 400px; }
        .login-form h2 { text-align: center; margin-bottom: 30px; color: #2c3e50; }
        .login-form .form-group { margin-bottom: 20px; }
        .login-form label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        .login-form input, .login-form select { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease; }
        .login-form input:focus, .login-form select:focus { outline: none; border-color: #3498db; }
        .login-form .btn { width: 100%; padding: 12px; background: #3498db; color: white; border: none; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .login-form .btn:hover { background: #2980b9; }
        .user-info { background: #2c3e50; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .user-info .user-details { display: flex; align-items: center; gap: 15px; }
        .user-info .logout-btn { background: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; }
        .user-info .logout-btn:hover { background: #c0392b; }
        .nav-container { background: #2c3e50; padding: 0; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .nav-tabs { display: flex; max-width: 1200px; margin: 0 auto; list-style: none; flex-wrap: wrap; }
        .nav-tab { flex: 1; text-align: center; min-width: 120px; }
        .nav-tab a { display: block; padding: 18px 15px; color: white; text-decoration: none; font-weight: 500; border-bottom: 3px solid transparent; transition: all 0.3s ease; font-size: 0.95em; cursor: pointer; }
        .nav-tab a.active { background: #34495e; border-bottom-color: #3498db; }
        .nav-tab a:hover { background: #34495e; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; background: white; min-height: calc(100vh - 130px); box-shadow: 0 0 20px rgba(0,0,0,0.1); }
        .header { text-align: center; margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px solid #ecf0f1; }
        .header h1 { color: #2c3e50; font-size: 1.8em; margin-bottom: 10px; font-weight: 300; }
        .stats { display: flex; justify-content: center; gap: 25px; margin-top: 25px; flex-wrap: wrap; }
        .stat-card { background: #f8f9fa; padding: 25px; border-radius: 10px; min-width: 160px; border: 1px solid #e9ecef; text-align: center; margin: 5px; }
        .stat-number { font-size: 1.8em; font-weight: bold; color: #2c3e50; display: block; }
        .stat-label { font-size: 0.8em; color: #7f8c8d; margin-top: 5px; }
        .form-section { max-width: 800px; margin: 0 auto; }
        .form-group { margin-bottom: 30px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; font-size: 14px; line-height: 1.4; }
        input, select, textarea { width: 100%; padding: 12px 15px; border: 2px solid #e9ecef; border-radius: 6px; font-size: 14px; transition: border-color 0.3s ease; background: white; line-height: 1.4; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #3498db; }
        .form-row { display: flex; gap: 20px; margin-bottom: 20px; align-items: flex-start; }
        .form-row .form-group { flex: 1; margin-bottom: 0; }
        .form-actions { display: flex; gap: 15px; margin-top: 30px; flex-wrap: wrap; justify-content: center; }
        .quick-actions { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin: 20px 0; }
        .back-actions { display: flex; justify-content: center; gap: 15px; margin-top: 30px; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; min-width: 140px; }
        .btn-primary { background: #3498db; color: white; }
        .btn-secondary { background: #95a5a6; color: white; }
        .btn-success { background: #27ae60; color: white; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-warning { background: #f39c12; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-table { padding: 8px 16px; margin: 2px 4px; font-size: 12px; }
        .table-container { background: white; border-radius: 8px; overflow: hidden; border: 1px solid #e9ecef; max-height: 500px; overflow-y: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #e9ecef; white-space: nowrap; }
        th { background: #34495e; color: white; font-weight: 600; position: sticky; top: 0; font-size: 12px; }
        td { font-size: 12px; }
        tr:hover { background: #f8f9fa; }
        .warehouse-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 25px; margin: 25px 0; }
        .warehouse-card { background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 10px; padding: 25px; text-align: center; transition: all 0.3s ease; }
        .warehouse-card.principal { border-color: #3498db; background: #ebf5fb; }
        .warehouse-card.secondaire { border-color: #27ae60; background: #eafaf1; }
        .warehouse-card.client { border-color: #f39c12; background: #fef9e7; }
        .warehouse-card.negative { border-color: #e74c3c; background: #fdedec; }
        .warehouse-card:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .warehouse-name { font-size: 1.2em; font-weight: bold; color: #2c3e50; margin-bottom: 10px; }
        .warehouse-balance { font-size: 1.5em; font-weight: bold; color: #34495e; margin: 10px 0; }
        .warehouse-balance.negative { color: #e74c3c; }
        .warehouse-type { font-size: 0.8em; color: #7f8c8d; text-transform: uppercase; }
        .page { display: none; }
        .page.active { display: block; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 6px; color: white; font-weight: 600; z-index: 1000; transform: translateX(400px); transition: transform 0.3s ease; font-size: 13px; }
        .notification.show { transform: translateX(0); }
        .notification.success { background: #27ae60; }
        .notification.error { background: #e74c3c; }
        .notification.info { background: #3498db; }
        .notification.warning { background: #f39c12; }
        .footer { text-align: center; padding: 20px; color: #7f8c8d; font-size: 12px; border-top: 1px solid #ecf0f1; margin-top: 40px; }
        .loading { display: none; text-align: center; padding: 20px; color: #3498db; font-size: 14px; }
        .config-section { background: #f8f9fa; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #e9ecef; }
        .config-section h3 { color: #2c3e50; margin-bottom: 15px; }
        
        .receipt-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 600px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        
        .receipt { 
            background: white; 
            padding: 30px 40px; 
            max-width: 700px; 
            width: 100%; 
            margin: 0 auto; 
            font-family: Arial, sans-serif; 
            border: 1px solid #ddd; 
            box-shadow: 0 3px 10px rgba(0,0,0,0.08); 
            border-radius: 5px; 
            text-align: center; 
            page-break-inside: avoid;
            page-break-after: avoid;
            page-break-before: avoid;
        }
        
        .receipt-header { 
            text-align: center; 
            padding-bottom: 20px; 
            margin-bottom: 20px; 
            border-bottom: 2px solid #2c3e50; 
        }
        
        .company-header { 
            font-size: 28px; 
            font-weight: bold; 
            margin-bottom: 5px; 
            color: #2c3e50; 
            letter-spacing: 2px;
        }
        
        .company-subheader { 
            font-size: 22px; 
            font-weight: bold; 
            margin-bottom: 15px; 
            color: #3498db; 
            letter-spacing: 1px;
        }
        
        .receipt-title { 
            font-size: 20px; 
            font-weight: bold; 
            margin-top: 15px; 
            padding-top: 10px; 
            color: #2c3e50; 
            border-top: 2px solid #2c3e50;
            display: inline-block;
            width: 100%;
        }
        
        .receipt-info { 
            margin-bottom: 25px; 
            text-align: left; 
            max-width: 550px; 
            margin-left: auto; 
            margin-right: auto; 
        }
        
        .receipt-info-row { 
            display: flex; 
            justify-content: space-between; 
            margin-bottom: 8px; 
            padding: 6px 0; 
            border-bottom: 1px solid #eee; 
        }
        
        .receipt-info-label { 
            font-weight: bold; 
            color: #555; 
            flex: 1; 
            font-size: 15px;
        }
        
        .receipt-info-value { 
            color: #333; 
            flex: 2; 
            text-align: right; 
            font-size: 15px;
        }
        
        .receipt-signature-section {
            margin-top: 40px;
            padding-top: 25px;
            border-top: 1px solid #ddd;
        }
        
        .signatures-container {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 40px;
        }
        
        .signature-box {
            flex: 1;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .signature-line {
            border-top: 1px solid #333;
            margin-top: 50px;
            padding-top: 8px;
            font-style: italic;
            color: #555;
            font-size: 14px;
        }
        
        .receipt-actions { 
            text-align: center; 
            margin: 30px 0; 
            display: flex; 
            gap: 15px; 
            justify-content: center; 
            flex-wrap: wrap; 
        }
        
        @media print {
            body { 
                margin: 0 !important;
                padding: 0 !important;
                background: white !important;
                height: 100vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            body * { 
                visibility: hidden; 
                margin: 0 !important;
                padding: 0 !important;
            }
            
            #receipt-print, #receipt-print * { 
                visibility: visible !important; 
            }
            
            #receipt-print {
                position: relative !important;
                left: 0 !important;
                top: 0 !important;
                transform: none !important;
                width: 100% !important;
                max-width: 700px !important;
                margin: auto !important;
                padding: 30px 40px !important;
                box-shadow: none !important;
                border: 1px solid #000 !important;
                background: white !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                page-break-before: avoid !important;
                break-inside: avoid !important;
                display: block !important;
            }
            
            .receipt-container {
                display: block !important;
                min-height: auto !important;
                padding: 0 !important;
                margin: 0 !important;
                width: 100% !important;
                height: 100% !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
            }
            
            .receipt {
                box-shadow: none !important;
                border: 1px solid #000 !important;
                margin: auto !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
            }
            
            .receipt-actions, .no-print { 
                display: none !important; 
            }
            
            .company-header, .company-subheader, .receipt-title {
                color: #000 !important;
            }
            
            .receipt-info-row {
                border-bottom: 1px solid #ccc !important;
            }
            
            .signature-line {
                border-top: 1px solid #000 !important;
            }
            
            .receipt-signature-section {
                border-top: 1px solid #000 !important;
            }
            
            @page {
                size: A4;
                margin: 20mm;
            }
        }
        
        @media (max-width: 768px) { 
            .form-actions, .receipt-actions { flex-direction: column; gap: 12px; } 
            .btn { width: 100%; margin: 3px 0; } 
            .stats { flex-direction: column; align-items: center; gap: 15px; } 
            .stat-card { width: 100%; max-width: 220px; } 
            .nav-tabs { flex-direction: column; gap: 5px; } 
            .form-row { flex-direction: column; gap: 15px; } 
            .warehouse-grid { grid-template-columns: 1fr; gap: 15px; } 
            .quick-actions { flex-direction: column; gap: 10px; } 
            .back-actions { flex-direction: column; gap: 10px; } 
            
            .receipt { padding: 20px; }
            .company-header { font-size: 24px; }
            .company-subheader { font-size: 20px; }
            .receipt-title { font-size: 18px; }
            .signatures-container { flex-direction: column; gap: 25px; }
            .receipt-info-row { flex-direction: column; }
            .receipt-info-value { text-align: left; margin-top: 5px; }
            
            @media print {
                #receipt-print {
                    padding: 20px !important;
                    max-width: 90% !important;
                    margin: 0 auto !important;
                }
                
                .company-header { font-size: 22px !important; }
                .company-subheader { font-size: 18px !important; }
                .receipt-title { font-size: 16px !important; }
                .signatures-container { flex-direction: column !important; }
            }
        }
    </style>
</head>
<body oncontextmenu="return false">
    <div id="login-page" class="login-container">
        <div class="login-form">
            <h2>SYST√àME DE SUIVI DES PALETTES</h2>
            <form id="login-form">
                <div class="form-group">
                    <label for="username">Nom d'utilisateur</label>
                    <input type="text" id="username" required>
                </div>
                <div class="form-group">
                    <label for="password">Mot de passe</label>
                    <input type="password" id="password" required>
                </div>
                <button type="submit" class="btn">Se connecter</button>
            </form>
        </div>
    </div>

    <div id="app" style="display: none;">
        <div class="user-info">
            <div class="user-details">
                <span id="user-name"></span>
                <span id="user-role"></span>
            </div>
            <button class="logout-btn" onclick="logout()">D√©connexion</button>
        </div>

        <nav class="nav-container">
            <ul class="nav-tabs">
                <li class="nav-tab"><a href="#" class="nav-link active" data-page="dashboard">üìä Tableau de Bord</a></li>
                <li class="nav-tab"><a href="#" class="nav-link" data-page="operations">üìù Op√©rations</a></li>
                <li class="nav-tab"><a href="#" class="nav-link" data-page="warehouses">üè™ Entrep√¥ts</a></li>
                <li class="nav-tab"><a href="#" class="nav-link" data-page="drivers">üë§ Chauffeurs</a></li>
                <li class="nav-tab"><a href="#" class="nav-link" data-page="history">üìã Historique</a></li>
                <li class="nav-tab"><a href="#" class="nav-link" data-page="config">‚öôÔ∏è Configuration</a></li>
                <li class="nav-tab" id="user-management-tab" style="display: none;"><a href="#" class="nav-link" data-page="users">üë• Utilisateurs</a></li>
            </ul>
        </nav>

        <div class="container">
            <div id="dashboard" class="page active">
                <div class="header">
                    <h1>SYST√àME DE SUIVI DES PALETTES</h1>
                    <p>Gestion et suivi des mouvements de palettes par quantit√©</p>
                    <div class="stats">
                        <div class="stat-card"><span class="stat-number" id="totalOperations">0</span><span class="stat-label">Total Op√©rations</span></div>
                        <div class="stat-card"><span class="stat-number" id="totalDrivers">0</span><span class="stat-label">Chauffeurs Actifs</span></div>
                        <div class="stat-card"><span class="stat-number" id="totalWarehouses">0</span><span class="stat-label">Entrep√¥ts</span></div>
                    </div>
                </div>
                <div style="margin: 30px 0;">
                    <h3 style="color: #2c3e50; margin-bottom: 25px; text-align: center;">Vue d'ensemble des Entrep√¥ts</h3>
                    <div class="warehouse-grid" id="warehouseOverview"></div>
                </div>
                <div style="text-align: center; margin: 35px 0;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Actions Rapides</h3>
                    <div class="quick-actions">
                        <button class="btn btn-primary" onclick="showPage('operations')">‚ûï Nouvelle Op√©ration</button>
                        <button class="btn btn-info" onclick="showPage('warehouses')">üè™ G√©rer Entrep√¥ts</button>
                        <button class="btn btn-warning" onclick="showPage('drivers')">üë§ G√©rer Chauffeurs</button>
                        <button class="btn btn-secondary" onclick="showPage('history')">üìã Voir Historique</button>
                    </div>
                </div>
            </div>

            <div id="operations" class="page">
                <div class="header"><h1>NOUVELLE OP√âRATION</h1><p>Enregistrer un nouveau mouvement de palettes</p></div>
                <div class="form-section">
                    <form id="operationForm" class="operation-form">
                        <div class="form-row">
                            <div class="form-group"><label for="date">Date de l'op√©ration</label><input type="date" id="date" required></div>
                            <div class="form-group"><label for="driver">Chauffeur</label><select id="driver" required><option value="">S√©lectionner un chauffeur</option></select></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="fromWarehouse">Entrep√¥t Source</label><select id="fromWarehouse" required><option value="">S√©lectionner l'entrep√¥t source</option></select></div>
                            <div class="form-group"><label for="toWarehouse">Entrep√¥t Destination</label><select id="toWarehouse" required><option value="">S√©lectionner l'entrep√¥t destination</option></select></div>
                        </div>
                        <div class="form-group"><label for="quantity">Quantit√© de Palettes</label><input type="number" id="quantity" min="1" required placeholder="Entrez le nombre de palettes"></div>
                        <div class="form-group">
                            <label for="operationType">Type d'op√©ration</label>
                            <select id="operationType" required>
                                <option value="transfert">Transfert entre entrep√¥ts</option>
                                <option value="envoi">Envoi vers client</option>
                                <option value="retour">Retour de client</option>
                                <option value="ajustement">Ajustement de stock</option>
                            </select>
                        </div>
                        <div class="form-group"><label for="notes">Notes</label><textarea id="notes" placeholder="Notes suppl√©mentaires..." rows="3"></textarea></div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">Enregistrer l'Op√©ration</button>
                            <button type="button" class="btn btn-secondary" onclick="generateReceipt()">G√©n√©rer D√©charge</button>
                            <button type="button" class="btn btn-danger" onclick="clearForm()">Effacer</button>
                            <button type="button" class="btn btn-secondary" onclick="showPage('dashboard')">Retour</button>
                        </div>
                    </form>
                </div>

                <div id="receipt-section" style="display: none;">
                    <div class="receipt-container">
                        <div class="receipt" id="receipt-print">
                            <div class="receipt-header">
                                <div class="company-header">LDM</div>
                                <div class="company-subheader">GROUPE</div>
                                <div class="receipt-title">D√âCHARGE LDM</div>
                            </div>
                            <div class="receipt-info">
                                <div class="receipt-info-row"><span class="receipt-info-label">Date:</span><span class="receipt-info-value" id="receipt-date"></span></div>
                                <div class="receipt-info-row"><span class="receipt-info-label">Chauffeur:</span><span class="receipt-info-value" id="receipt-driver"></span></div>
                                <div class="receipt-info-row"><span class="receipt-info-label">De:</span><span class="receipt-info-value" id="receipt-from"></span></div>
                                <div class="receipt-info-row"><span class="receipt-info-label">Vers:</span><span class="receipt-info-value" id="receipt-to"></span></div>
                                <div class="receipt-info-row"><span class="receipt-info-label">Quantit√©:</span><span class="receipt-info-value" id="receipt-quantity"></span></div>
                                <div class="receipt-info-row"><span class="receipt-info-label">Type d'op√©ration:</span><span class="receipt-info-value" id="receipt-type"></span></div>
                                <div class="receipt-info-row"><span class="receipt-info-label">Notes:</span><span class="receipt-info-value" id="receipt-notes"></span></div>
                            </div>
                            <div class="receipt-signature-section">
                                <p>Je soussign√©, reconnais avoir re√ßu la quantit√© de palettes mentionn√©e ci-dessus en bon √©tat.</p>
                                
                                <div class="signatures-container">
                                    <div class="signature-box" style="text-align: left;">
                                        <div class="signature-line" style="margin-top: 50px;">
                                            Signature du chauffeur
                                        </div>
                                    </div>
                                    
                                    <div class="signature-box" style="text-align: right;">
                                        <div class="signature-line" style="margin-top: 50px;">
                                            Signature du responsable de stock
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="receipt-actions">
                        <button class="btn btn-primary" onclick="printReceipt()">üñ®Ô∏è Imprimer</button>
                        <button class="btn btn-success" onclick="saveReceiptAsPDF()">üíæ Sauvegarder PDF</button>
                        <button class="btn btn-info" onclick="saveReceiptAsImage()">üñºÔ∏è Sauvegarder Image</button>
                        <button class="btn btn-secondary" onclick="closeReceipt()">Fermer</button>
                    </div>
                </div>
            </div>

            <div id="warehouses" class="page">
                <div class="header"><h1>GESTION DES ENTREP√îTS</h1><p>Ajouter, modifier et supprimer des entrep√¥ts</p></div>
                <div class="form-section">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Ajouter un Nouvel Entrep√¥t</h3>
                    <form id="warehouseForm">
                        <div class="form-row">
                            <div class="form-group"><label for="warehouseName">Nom de l'entrep√¥t</label><input type="text" id="warehouseName" required placeholder="Nom de l'entrep√¥t"></div>
                            <div class="form-group">
                                <label for="warehouseType">Type d'entrep√¥t</label>
                                <select id="warehouseType" required>
                                    <option value="principal">Principal</option>
                                    <option value="secondaire">Secondaire</option>
                                    <option value="client">Client</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="initialBalance">Solde Initial</label><input type="number" id="initialBalance" value="0" required placeholder="Solde initial"></div>
                            <div class="form-group"><label for="warehouseLocation">Emplacement</label><input type="text" id="warehouseLocation" placeholder="Emplacement de l'entrep√¥t"></div>
                        </div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-success">Ajouter l'Entrep√¥t</button>
                            <button type="button" class="btn btn-secondary" onclick="clearWarehouseForm()">Effacer</button>
                        </div>
                    </form>
                </div>
                <div style="margin-top: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Liste des Entrep√¥ts</h3>
                    <div class="table-container">
                        <table id="warehousesTable"><thead><tr><th>ID</th><th>Nom</th><th>Type</th><th>Solde</th><th>Emplacement</th><th>Actions</th></tr></thead><tbody id="warehousesBody"></tbody></table>
                    </div>
                </div>
                <div class="back-actions"><button class="btn btn-secondary" onclick="showPage('dashboard')">Retour au Tableau de Bord</button></div>
            </div>

            <div id="drivers" class="page">
                <div class="header"><h1>GESTION DES CHAUFFEURS</h1><p>Ajouter, modifier et supprimer des chauffeurs</p></div>
                <div class="form-section">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Ajouter un Nouveau Chauffeur</h3>
                    <form id="driverForm">
                        <div class="form-row">
                            <div class="form-group"><label for="driverName">Nom du chauffeur</label><input type="text" id="driverName" required placeholder="Nom du chauffeur"></div>
                            <div class="form-group"><label for="driverPhone">T√©l√©phone</label><input type="tel" id="driverPhone" placeholder="Num√©ro de t√©l√©phone"></div>
                        </div>
                        <div class="form-group"><label for="driverStatus">Statut</label><select id="driverStatus" required><option value="active">Actif</option><option value="inactive">Inactif</option></select></div>
                        <div class="form-actions"><button type="submit" class="btn btn-success">Ajouter le Chauffeur</button><button type="button" class="btn btn-secondary" onclick="clearDriverForm()">Effacer</button></div>
                    </form>
                </div>
                <div style="margin-top: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Liste des Chauffeurs</h3>
                    <div class="table-container">
                        <table id="driversTable"><thead><tr><th>ID</th><th>Nom</th><th>T√©l√©phone</th><th>Statut</th><th>Date d'ajout</th><th>Actions</th></tr></thead><tbody id="driversBody"></tbody></table>
                    </div>
                </div>
                <div class="back-actions"><button class="btn btn-secondary" onclick="showPage('dashboard')">Retour au Tableau de Bord</button></div>
            </div>

            <div id="history" class="page">
                <div class="header"><h1>HISTORIQUE DES OP√âRATIONS</h1><p>Consultation et gestion des op√©rations pass√©es</p></div>
                <div class="table-container">
                    <table id="operationsTable"><thead><tr><th>Date</th><th>Utilisateur</th><th>Chauffeur</th><th>Description</th><th>D√©tails</th><th>Type</th></tr></thead><tbody id="operationsBody"></tbody></table>
                </div>
                <div class="back-actions">
                    <button class="btn btn-secondary" onclick="showPage('dashboard')">Retour au Tableau de Bord</button>
                    <button class="btn btn-primary" onclick="loadOperationsHistory()">Actualiser</button>
                    <button class="btn btn-info" onclick="exportToCSV()">Exporter CSV</button>
                </div>
            </div>

            <div id="config" class="page">
                <div class="header"><h1>CONFIGURATION DU SYST√àME</h1><p>Param√®tres et configuration de la base de donn√©es</p></div>
                <div class="config-section">
                    <h3>Configuration de la Base de Donn√©es</h3>
                    <p>Le syst√®me utilise JSONBin.io pour le stockage cloud.</p>
                    <div class="form-actions">
                        <button class="btn btn-primary" onclick="backupDatabase()">Sauvegarder la Base</button>
                        <button class="btn btn-info" onclick="restoreDatabase()">Restaurer la Base</button>
                        <button class="btn btn-danger" onclick="resetDatabase()">R√©initialiser la Base</button>
                    </div>
                </div>
                <div class="back-actions"><button class="btn btn-secondary" onclick="showPage('dashboard')">Retour au Tableau de Bord</button></div>
            </div>

            <div id="users" class="page">
                <div class="header"><h1>GESTION DES UTILISATEURS</h1><p>Ajouter, modifier et supprimer des utilisateurs</p></div>
                <div class="form-section">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Ajouter un Nouvel Utilisateur</h3>
                    <form id="userForm">
                        <div class="form-row">
                            <div class="form-group"><label for="newUserName">Nom d'utilisateur</label><input type="text" id="newUserName" required placeholder="Nom d'utilisateur"></div>
                            <div class="form-group"><label for="newUserPassword">Mot de passe</label><input type="password" id="newUserPassword" required placeholder="Mot de passe"></div>
                        </div>
                        <div class="form-row">
                            <div class="form-group"><label for="newUserFullName">Nom complet</label><input type="text" id="newUserFullName" required placeholder="Nom complet"></div>
                            <div class="form-group"><label for="newUserRole">R√¥le</label><select id="newUserRole" required><option value="admin">Administrateur</option><option value="operator">Op√©rateur</option><option value="viewer">Observateur</option></select></div>
                        </div>
                        <div class="form-actions"><button type="submit" class="btn btn-success">Ajouter l'Utilisateur</button><button type="button" class="btn btn-secondary" onclick="clearUserForm()">Effacer</button></div>
                    </form>
                </div>
                <div style="margin-top: 40px;">
                    <h3 style="color: #2c3e50; margin-bottom: 20px;">Liste des Utilisateurs</h3>
                    <div class="table-container">
                        <table id="usersTable"><thead><tr><th>ID</th><th>Nom d'utilisateur</th><th>Nom complet</th><th>R√¥le</th><th>Date de cr√©ation</th><th>Actions</th></tr></thead><tbody id="usersBody"></tbody></table>
                    </div>
                </div>
                <div class="back-actions"><button class="btn btn-secondary" onclick="showPage('dashboard')">Retour au Tableau de Bord</button></div>
            </div>
            <footer class="footer"><p>Syst√®me de Suivi des Palettes</p></footer>
        </div>
    </div>
    <div id="notification" class="notification"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        // ========== Configuration JSONBin.io ==========
        // ‚ö†Ô∏è IMPORTANT: Remplacez ces valeurs par vos propres cl√©s ‚ö†Ô∏è
        const CONFIG = {
            // ÿßŸÑŸÖŸÅÿ™ÿßÿ≠ ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿä - ÿ¨ÿ±ÿ®Ÿá ŸÖŸÜ ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ JSONBin
            MASTER_KEY: "$2a$10$JoxiVVHTMYPI9djA9QDHx.3.1AN.9YJYRbES35GBLNqHepbHYwKRe",
            
            // ŸÖÿπÿ±ŸÅÿßÿ™ ÿßŸÑŸÄ Bins - ÿ∂ÿπ ŸÉŸÑ Bin ID ŸÅŸä ÿßŸÑŸÖŸÉÿßŸÜ ÿßŸÑŸÖŸÜÿßÿ≥ÿ®
            BINS: {
                USERS: "6999938043b1c97be990dfa9",        // Bin 1: ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ
                WAREHOUSES: "699993bb43b1c97be990e03e",      // Bin 2: ÿßŸÑŸÖÿ≥ÿ™ŸàÿØÿπÿßÿ™
                DRIVERS: "699993e8ae596e708f3ca7dd",        // Bin 3: ÿßŸÑÿ≥ÿßÿ¶ŸÇŸäŸÜ
                OPERATIONS: "6999940dd0ea881f40cc4430",     // Bin 4: ÿßŸÑÿπŸÖŸÑŸäÿßÿ™
                HISTORY: "69999430ae596e708f3ca879"          // Bin 5: ÿßŸÑÿ≥ÿ¨ŸÑ
            },
            
            API_URL: "https://api.jsonbin.io/v3/b"
        };

        // V√©rification que la configuration est compl√®te
        if (CONFIG.MASTER_KEY.includes("METS_TON")) {
            alert("‚ö†Ô∏è ATTENTION: Vous devez configurer vos cl√©s JSONBin.io dans le code!");
        }

        let currentUser = null;
        let users = [{ id: 1, username: "admin", password: "admin123", fullName: "Administrateur Principal", role: "admin", dateAdded: "2025-10-30" }];
        let warehouses = [];
        let drivers = [];
        let operations = [];
        let history = [];

        // ========== Fonctions JSONBin.io ==========
        
        // ÿØÿßŸÑÿ© ŸÑÿ¨ŸÑÿ® ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ JSONBin
        async function fetchFromJSONBin(binId) {
            try {
                const response = await fetch(`${CONFIG.API_URL}/${binId}/latest`, {
                    method: 'GET',
                    headers: {
                        'X-Master-Key': CONFIG.MASTER_KEY,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                return data.record;
            } catch (error) {
                console.error('Error fetching from JSONBin:', error);
                return null;
            }
        }

        // ÿØÿßŸÑÿ© ŸÑÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÅŸä JSONBin
        async function saveToJSONBin(binId, data) {
            // ÿ™ÿ¨ŸÜÿ® ÿßŸÑÿ≠ŸÅÿ∏ ÿ•ÿ∞ÿß ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ŸÉŸàŸäŸÜ ÿßŸÑŸÖŸÅÿßÿ™Ÿäÿ≠
            if (CONFIG.MASTER_KEY.includes("METS_TON")) {
                console.warn("Configuration JSONBin manquante, sauvegarde locale seulement");
                return false;
            }
            
            try {
                const response = await fetch(`${CONFIG.API_URL}/${binId}`, {
                    method: 'PUT',
                    headers: {
                        'X-Master-Key': CONFIG.MASTER_KEY,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                return true;
            } catch (error) {
                console.error('Error saving to JSONBin:', error);
                return false;
            }
        }

        // ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© saveData ŸÑÿ™ÿπŸÖŸÑ ŸÖÿπ JSONBin
        async function saveData() {
            // ÿ≠ŸÅÿ∏ ŸÖÿ≠ŸÑŸä (ŸÉÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä)
            const localData = { warehouses, drivers, operations, users, history };
            localStorage.setItem('paletteSystemData', JSON.stringify(localData));
            
            // ÿ≠ŸÅÿ∏ ÿπŸÑŸâ JSONBin
            try {
                await Promise.all([
                    saveToJSONBin(CONFIG.BINS.USERS, { users }),
                    saveToJSONBin(CONFIG.BINS.WAREHOUSES, { warehouses }),
                    saveToJSONBin(CONFIG.BINS.DRIVERS, { drivers }),
                    saveToJSONBin(CONFIG.BINS.OPERATIONS, { operations }),
                    saveToJSONBin(CONFIG.BINS.HISTORY, { history })
                ]);
                
                console.log('‚úÖ Donn√©es sauvegard√©es sur JSONBin');
            } catch (error) {
                console.error('‚ùå Erreur sauvegarde JSONBin:', error);
            }
        }

        // ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© loadInitialData ŸÑÿ™ÿπŸÖŸÑ ŸÖÿπ JSONBin
        async function loadInitialData() {
            showNotification('Chargement des donn√©es...', 'info');
            
            try {
                // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ JSONBin
                const [usersData, warehousesData, driversData, operationsData, historyData] = await Promise.all([
                    fetchFromJSONBin(CONFIG.BINS.USERS),
                    fetchFromJSONBin(CONFIG.BINS.WAREHOUSES),
                    fetchFromJSONBin(CONFIG.BINS.DRIVERS),
                    fetchFromJSONBin(CONFIG.BINS.OPERATIONS),
                    fetchFromJSONBin(CONFIG.BINS.HISTORY)
                ]);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿ®ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÖŸÑÿ©
                if (usersData?.users) users = usersData.users;
                if (warehousesData?.warehouses) warehouses = warehousesData.warehouses;
                if (driversData?.drivers) drivers = driversData.drivers;
                if (operationsData?.operations) operations = operationsData.operations;
                if (historyData?.history) history = historyData.history;
                
                // ÿ•ÿ∞ÿß ŸÉÿßŸÜÿ™ JSONBin ŸÅÿßÿ±ÿ∫ÿ©ÿå ÿßÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©
                if (!usersData && !warehousesData && !driversData && !operationsData && !historyData) {
                    const savedData = localStorage.getItem('paletteSystemData');
                    if (savedData) {
                        const data = JSON.parse(savedData);
                        warehouses = data.warehouses || [];
                        drivers = data.drivers || [];
                        operations = data.operations || [];
                        users = data.users || users;
                        history = data.history || [];
                        
                        // ÿ≠ŸÅÿ∏ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ÿπŸÑŸâ JSONBin
                        await saveData();
                    } else {
                        // ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©
                        await saveData();
                    }
                }
                
                showNotification('Donn√©es charg√©es avec succ√®s!', 'success');
                
            } catch (error) {
                console.error('Erreur chargement JSONBin:', error);
                // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ© ŸÉÿßÿ≠ÿ™Ÿäÿßÿ∑Ÿä
                const savedData = localStorage.getItem('paletteSystemData');
                if (savedData) {
                    const data = JSON.parse(savedData);
                    warehouses = data.warehouses || [];
                    drivers = data.drivers || [];
                    operations = data.operations || [];
                    users = data.users || users;
                    history = data.history || [];
                }
                showNotification('Utilisation des donn√©es locales (mode hors ligne)', 'warning');
            }
            
            // ÿ™ÿ≠ÿØŸäÿ´ Ÿàÿßÿ¨Ÿáÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
            loadDashboardData();
            loadWarehouses();
            loadDrivers();
            loadOperationsHistory();
        }

        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const user = users.find(u => u.username === username && u.password === password);
                if (user) {
                    currentUser = user;
                    localStorage.setItem('currentUser', JSON.stringify(user));
                    document.getElementById('login-page').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                    document.getElementById('user-name').textContent = user.fullName;
                    document.getElementById('user-role').textContent = `(${getRoleName(user.role)})`;
                    if (user.role === 'admin') document.getElementById('user-management-tab').style.display = 'block';
                    loadInitialData(); // Cette fonction est maintenant async
                    showNotification('Connexion r√©ussie!', 'success');
                } else { showNotification('Nom d\'utilisateur ou mot de passe incorrect!', 'error'); }
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.getAttribute('data-page');
                    if (!checkPermission(page)) { showNotification('Vous n\'avez pas la permission d\'acc√©der √† cette page.', 'error'); return; }
                    showPage(page);
                });
            });
            document.getElementById('operationForm').addEventListener('submit', function(e) { e.preventDefault(); addOperation(); });
            document.getElementById('warehouseForm').addEventListener('submit', function(e) { e.preventDefault(); addWarehouse(); });
            document.getElementById('driverForm').addEventListener('submit', function(e) { e.preventDefault(); addDriver(); });
            document.getElementById('userForm').addEventListener('submit', function(e) { e.preventDefault(); addUser(); });
            document.getElementById('date').valueAsDate = new Date();
        });

        function checkLoginStatus() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('app').style.display = 'block';
                document.getElementById('user-name').textContent = currentUser.fullName;
                document.getElementById('user-role').textContent = `(${getRoleName(currentUser.role)})`;
                if (currentUser.role === 'admin') document.getElementById('user-management-tab').style.display = 'block';
                loadInitialData();
            }
        }

        function getRoleName(role) {
            switch(role) { case 'admin': return 'Administrateur'; case 'operator': return 'Op√©rateur'; case 'viewer': return 'Observateur'; default: return 'Utilisateur'; }
        }

        function checkPermission(page) {
            if (!currentUser) return false;
            switch(currentUser.role) { case 'admin': return true; case 'operator': return page !== 'users' && page !== 'config'; case 'viewer': return page === 'dashboard' || page === 'history'; default: return false; }
        }

        function checkActionPermission(action) {
            if (!currentUser) return false;
            switch(currentUser.role) { case 'admin': return true; case 'operator': if (action === 'backup_database' || action === 'restore_database') return true; return action !== 'manage_users' && action !== 'config' && action !== 'reset_database'; case 'viewer': return false; default: return false; }
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            document.getElementById('app').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
            showNotification('D√©connexion r√©ussie!', 'info');
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            document.querySelector(`[data-page="${pageId}"]`).classList.add('active');
            if (pageId === 'operations') loadOperationsFormData();
            else if (pageId === 'users') loadUsers();
            else if (pageId === 'dashboard') loadDashboardData();
            else if (pageId === 'warehouses') loadWarehouses();
            else if (pageId === 'drivers') loadDrivers();
            else if (pageId === 'history') loadOperationsHistory();
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            setTimeout(() => notification.classList.remove('show'), 4000);
        }

        function addHistoryEntry(type, description, details = {}) {
            const historyEntry = { id: history.length > 0 ? Math.max(...history.map(h => h.id)) + 1 : 1, timestamp: new Date().toISOString(), type, description, details, user: currentUser.fullName };
            history.push(historyEntry);
            saveData();
        }

        function loadDashboardData() {
            document.getElementById('totalOperations').textContent = operations.length;
            document.getElementById('totalDrivers').textContent = drivers.filter(d => d.status === 'active').length;
            document.getElementById('totalWarehouses').textContent = warehouses.length;
            const warehouseOverview = document.getElementById('warehouseOverview');
            warehouseOverview.innerHTML = '';
            warehouses.forEach(warehouse => {
                const balanceClass = warehouse.balance < 0 ? 'negative' : '';
                const cardClass = warehouse.balance < 0 ? 'warehouse-card negative' : `warehouse-card ${warehouse.type}`;
                const warehouseCard = document.createElement('div');
                warehouseCard.className = cardClass;
                warehouseCard.innerHTML = `<div class="warehouse-name">${warehouse.name}</div><div class="warehouse-type">${getWarehouseTypeName(warehouse.type)}</div><div class="warehouse-balance ${balanceClass}">${warehouse.balance}</div><div>Palettes</div>`;
                warehouseOverview.appendChild(warehouseCard);
            });
        }

        function getWarehouseTypeName(type) {
            switch(type) { case 'principal': return 'Principal'; case 'secondaire': return 'Secondaire'; case 'client': return 'Client'; default: return type; }
        }

        function loadOperationsFormData() {
            const driverSelect = document.getElementById('driver');
            driverSelect.innerHTML = '<option value="">S√©lectionner un chauffeur</option>';
            drivers.filter(d => d.status === 'active').forEach(driver => {
                const option = document.createElement('option');
                option.value = driver.id;
                option.textContent = driver.name;
                driverSelect.appendChild(option);
            });
            const fromWarehouseSelect = document.getElementById('fromWarehouse');
            const toWarehouseSelect = document.getElementById('toWarehouse');
            fromWarehouseSelect.innerHTML = '<option value="">S√©lectionner l\'entrep√¥t source</option>';
            toWarehouseSelect.innerHTML = '<option value="">S√©lectionner l\'entrep√¥t destination</option>';
            warehouses.forEach(warehouse => {
                const option1 = document.createElement('option');
                option1.value = warehouse.id;
                option1.textContent = `${warehouse.name} (${warehouse.balance})`;
                fromWarehouseSelect.appendChild(option1);
                const option2 = document.createElement('option');
                option2.value = warehouse.id;
                option2.textContent = `${warehouse.name} (${warehouse.balance})`;
                toWarehouseSelect.appendChild(option2);
            });
        }

        async function addOperation() {
            if (!checkActionPermission('add_operation')) { showNotification('Vous n\'avez pas la permission d\'ajouter des op√©rations.', 'error'); return; }
            const date = document.getElementById('date').value;
            const driverId = parseInt(document.getElementById('driver').value);
            const fromWarehouseId = parseInt(document.getElementById('fromWarehouse').value);
            const toWarehouseId = parseInt(document.getElementById('toWarehouse').value);
            const quantity = parseInt(document.getElementById('quantity').value);
            const type = document.getElementById('operationType').value;
            const notes = document.getElementById('notes').value;
            if (fromWarehouseId === toWarehouseId) { showNotification('L\'entrep√¥t source et destination ne peuvent pas √™tre identiques.', 'error'); return; }
            const fromWarehouse = warehouses.find(w => w.id === fromWarehouseId);
            const toWarehouse = warehouses.find(w => w.id === toWarehouseId);
            const driver = drivers.find(d => d.id === driverId);
            if (!driver) { showNotification('Chauffeur non trouv√©!', 'error'); return; }
            const newOperation = { id: operations.length > 0 ? Math.max(...operations.map(o => o.id)) + 1 : 1, date, driverId, driverName: driver.name, fromWarehouseId, toWarehouseId, quantity, type, notes, timestamp: new Date().toISOString(), user: currentUser.fullName };
            fromWarehouse.balance -= quantity;
            toWarehouse.balance += quantity;
            operations.push(newOperation);
            await saveData(); // ÿßŸÜÿ™ÿ∏ÿßÿ± ÿßŸÑÿ≠ŸÅÿ∏
            addHistoryEntry('operation', `Op√©ration de ${quantity} palettes`, { chauffeur: driver.name, source: fromWarehouse.name, dest: toWarehouse.name, qte: quantity, type: type });
            loadDashboardData();
            loadOperationsHistory();
            clearForm();
            showNotification('Op√©ration enregistr√©e avec succ√®s!', 'success');
        }

        function clearForm() { document.getElementById('operationForm').reset(); document.getElementById('date').valueAsDate = new Date(); }

        function generateReceipt() {
            const date = document.getElementById('date').value;
            const driverId = parseInt(document.getElementById('driver').value);
            const fromWarehouseId = parseInt(document.getElementById('fromWarehouse').value);
            const toWarehouseId = parseInt(document.getElementById('toWarehouse').value);
            const quantity = document.getElementById('quantity').value;
            const type = document.getElementById('operationType').value;
            const notes = document.getElementById('notes').value;
            if (!date || !driverId || !fromWarehouseId || !toWarehouseId || !quantity) { showNotification('Veuillez remplir tous les champs obligatoires.', 'error'); return; }
            const driver = drivers.find(d => d.id === driverId);
            const fromWarehouse = warehouses.find(w => w.id === fromWarehouseId);
            const toWarehouse = warehouses.find(w => w.id === toWarehouseId);
            document.getElementById('receipt-date').textContent = date;
            document.getElementById('receipt-driver').textContent = driver ? driver.name : '';
            document.getElementById('receipt-from').textContent = fromWarehouse ? fromWarehouse.name : '';
            document.getElementById('receipt-to').textContent = toWarehouse ? toWarehouse.name : '';
            document.getElementById('receipt-quantity').textContent = quantity + ' palettes';
            document.getElementById('receipt-type').textContent = document.getElementById('operationType').options[document.getElementById('operationType').selectedIndex].text;
            document.getElementById('receipt-notes').textContent = notes || 'Aucune';
            document.getElementById('receipt-section').style.display = 'block';
            
            document.getElementById('receipt-section').scrollIntoView({ behavior: 'smooth' });
        }

        function printReceipt() { 
            showNotification('Pr√©paration de l\'impression...', 'info');
            
            setTimeout(() => {
                window.print();
            }, 300);
        }

        function saveReceiptAsPDF() {
            const element = document.getElementById('receipt-print');
            const fromWarehouseId = parseInt(document.getElementById('fromWarehouse').value);
            const toWarehouseId = parseInt(document.getElementById('toWarehouse').value);
            
            let destinationName = "Destination";
            if (toWarehouseId) {
                const toWarehouse = warehouses.find(w => w.id === toWarehouseId);
                if (toWarehouse) {
                    destinationName = toWarehouse.name.replace(/[^a-zA-Z0-9]/g, '_');
                }
            }
            
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            
            const opt = {
                margin: 10,
                filename: `Decharge_LDM_${dateString}_${destinationName}.pdf`,
                image: { 
                    type: 'jpeg', 
                    quality: 0.98 
                },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    logging: false,
                    scrollX: 0,
                    scrollY: 0,
                    windowWidth: element.scrollWidth,
                    windowHeight: element.scrollHeight,
                    width: element.offsetWidth,
                    height: element.offsetHeight
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait',
                    compress: true
                }
            };
            
            showNotification('G√©n√©ration du PDF en cours...', 'info');
            
            html2pdf().set(opt).from(element).save().then(() => {
                showNotification('D√©charge sauvegard√©e en PDF avec succ√®s!', 'success');
            }).catch(err => {
                console.error('Erreur PDF:', err);
                showNotification('Erreur lors de la g√©n√©ration du PDF. Veuillez r√©essayer.', 'error');
            });
        }

        function saveReceiptAsImage() {
            const element = document.getElementById('receipt-print');
            const fromWarehouseId = parseInt(document.getElementById('fromWarehouse').value);
            const toWarehouseId = parseInt(document.getElementById('toWarehouse').value);
            
            let destinationName = "Destination";
            if (toWarehouseId) {
                const toWarehouse = warehouses.find(w => w.id === toWarehouseId);
                if (toWarehouse) {
                    destinationName = toWarehouse.name.replace(/[^a-zA-Z0-9]/g, '_');
                }
            }
            
            const today = new Date();
            const dateString = today.toISOString().split('T')[0];
            
            html2canvas(element, { 
                scale: 2,
                useCORS: true,
                backgroundColor: '#ffffff',
                logging: false,
                scrollX: 0,
                scrollY: 0,
                windowWidth: element.scrollWidth,
                windowHeight: element.scrollHeight,
                width: element.offsetWidth,
                height: element.offsetHeight
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = `Decharge_LDM_${dateString}_${destinationName}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showNotification('D√©charge sauvegard√©e en image!', 'success');
            }).catch(err => {
                console.error('Erreur image:', err);
                showNotification('Erreur lors de la g√©n√©ration de l\'image.', 'error');
            });
        }

        function closeReceipt() { document.getElementById('receipt-section').style.display = 'none'; }

        function loadWarehouses() {
            const warehousesBody = document.getElementById('warehousesBody');
            warehousesBody.innerHTML = '';
            warehouses.forEach(warehouse => {
                const balanceClass = warehouse.balance < 0 ? 'negative' : '';
                const row = document.createElement('tr');
                row.innerHTML = `<td>${warehouse.id}</td><td>${warehouse.name}</td><td>${getWarehouseTypeName(warehouse.type)}</td><td class="${balanceClass}">${warehouse.balance}</td><td>${warehouse.location || '-'}</td><td>${checkActionPermission('edit_warehouse') ? `<button class="btn btn-warning btn-table" onclick="editWarehouse(${warehouse.id})">Modifier</button>` : ''} ${checkActionPermission('delete_warehouse') ? `<button class="btn btn-danger btn-table" onclick="deleteWarehouse(${warehouse.id})">Supprimer</button>` : ''}</td>`;
                warehousesBody.appendChild(row);
            });
        }

        async function addWarehouse() {
            if (!checkActionPermission('add_warehouse')) { showNotification('Permission refus√©e.', 'error'); return; }
            const name = document.getElementById('warehouseName').value;
            const type = document.getElementById('warehouseType').value;
            const balance = parseInt(document.getElementById('initialBalance').value);
            const location = document.getElementById('warehouseLocation').value;
            const newWarehouse = { id: warehouses.length > 0 ? Math.max(...warehouses.map(w => w.id)) + 1 : 1, name, type, balance, location };
            warehouses.push(newWarehouse);
            await saveData();
            loadWarehouses();
            loadDashboardData();
            clearWarehouseForm();
            showNotification('Entrep√¥t ajout√©!', 'success');
        }

        function clearWarehouseForm() { document.getElementById('warehouseForm').reset(); document.getElementById('initialBalance').value = 0; }

        function editWarehouse(id) {
            if (!checkActionPermission('edit_warehouse')) return;
            const warehouse = warehouses.find(w => w.id === id);
            if (warehouse) {
                document.getElementById('warehouseName').value = warehouse.name;
                document.getElementById('warehouseType').value = warehouse.type;
                document.getElementById('initialBalance').value = warehouse.balance;
                document.getElementById('warehouseLocation').value = warehouse.location || '';
                deleteWarehouse(id, false);
                showNotification('Modifiez puis sauvegardez.', 'info');
            }
        }

        async function deleteWarehouse(id, notify = true) {
            if (!checkActionPermission('delete_warehouse')) return;
            warehouses = warehouses.filter(w => w.id !== id);
            await saveData();
            loadWarehouses();
            loadDashboardData();
            if (notify) showNotification('Supprim√©!', 'success');
        }

        function loadDrivers() {
            const driversBody = document.getElementById('driversBody');
            driversBody.innerHTML = '';
            drivers.forEach(driver => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${driver.id}</td><td>${driver.name}</td><td>${driver.phone || '-'}</td><td>${driver.status === 'active' ? 'Actif' : 'Inactif'}</td><td>${driver.dateAdded}</td><td>${checkActionPermission('edit_driver') ? `<button class="btn btn-warning btn-table" onclick="editDriver(${driver.id})">Modifier</button>` : ''} ${checkActionPermission('delete_driver') ? `<button class="btn btn-danger btn-table" onclick="deleteDriver(${driver.id})">Supprimer</button>` : ''}</td>`;
                driversBody.appendChild(row);
            });
        }

        async function addDriver() {
            if (!checkActionPermission('add_driver')) { showNotification('Permission refus√©e.', 'error'); return; }
            const name = document.getElementById('driverName').value;
            const phone = document.getElementById('driverPhone').value;
            const status = document.getElementById('driverStatus').value;
            const newDriver = { id: drivers.length > 0 ? Math.max(...drivers.map(d => d.id)) + 1 : 1, name, phone, status, dateAdded: new Date().toISOString().split('T')[0] };
            drivers.push(newDriver);
            await saveData();
            loadDrivers();
            loadDashboardData();
            clearDriverForm();
            showNotification('Chauffeur ajout√©!', 'success');
        }

        function clearDriverForm() { document.getElementById('driverForm').reset(); }

        function editDriver(id) {
            if (!checkActionPermission('edit_driver')) return;
            const driver = drivers.find(d => d.id === id);
            if (driver) {
                document.getElementById('driverName').value = driver.name;
                document.getElementById('driverPhone').value = driver.phone || '';
                document.getElementById('driverStatus').value = driver.status;
                deleteDriver(id, false);
                showNotification('Modifiez puis sauvegardez.', 'info');
            }
        }

        async function deleteDriver(id, notify = true) {
            if (!checkActionPermission('delete_driver')) return;
            drivers = drivers.filter(d => d.id !== id);
            await saveData();
            loadDrivers();
            loadDashboardData();
            if (notify) showNotification('Supprim√©!', 'success');
        }

        function loadOperationsHistory() {
            const operationsBody = document.getElementById('operationsBody');
            operationsBody.innerHTML = '';
            const allActivities = [...operations.map(op => ({ type: 'operation', date: op.date, user: op.user, driver: op.driverName, description: `Transfert de ${op.quantity} palettes`, details: `${warehouses.find(w => w.id === op.fromWarehouseId)?.name || 'N/A'} -> ${warehouses.find(w => w.id === op.toWarehouseId)?.name || 'N/A'}`, timestamp: op.timestamp })), ...history.map(h => ({ type: h.type, date: new Date(h.timestamp).toLocaleDateString('fr-FR'), user: h.user, driver: h.details.chauffeur || '-', description: h.description, details: JSON.stringify(h.details), timestamp: h.timestamp }))].sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            if (allActivities.length === 0) { operationsBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">Aucune activit√©</td></tr>'; return; }
            allActivities.forEach(activity => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${activity.date}</td><td>${activity.user}</td><td>${activity.driver || '-'}</td><td>${activity.description}</td><td>${activity.details}</td><td>${activity.type === 'operation' ? 'üîÑ' : 'üìù'}</td>`;
                operationsBody.appendChild(row);
            });
        }

        function exportToCSV() {
            if (!checkActionPermission('export_data')) return;
            let csv = "Date,Utilisateur,Chauffeur,Description,D√©tails\n";
            operations.forEach(op => { csv += `"${op.date}","${op.user}","${op.driverName}","Transfert ${op.quantity}","${op.notes || ''}"\n`; });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv;charset=utf-8;' }));
            link.download = "historique.csv";
            link.click();
        }

        function loadUsers() {
            if (!checkActionPermission('manage_users')) return;
            const usersBody = document.getElementById('usersBody');
            usersBody.innerHTML = '';
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${user.id}</td><td>${user.username}</td><td>${user.fullName}</td><td>${getRoleName(user.role)}</td><td>${user.dateAdded}</td><td><button class="btn btn-warning btn-table" onclick="editUser(${user.id})">Modifier</button> ${user.id !== currentUser.id ? `<button class="btn btn-danger btn-table" onclick="deleteUser(${user.id})">Supprimer</button>` : ''}</td>`;
                usersBody.appendChild(row);
            });
        }

        async function addUser() {
            if (!checkActionPermission('manage_users')) return;
            const username = document.getElementById('newUserName').value;
            if (users.some(u => u.username === username)) { showNotification('Existe d√©j√†!', 'error'); return; }
            const newUser = { id: users.length + 1, username, password: document.getElementById('newUserPassword').value, fullName: document.getElementById('newUserFullName').value, role: document.getElementById('newUserRole').value, dateAdded: new Date().toISOString().split('T')[0] };
            users.push(newUser);
            await saveData();
            loadUsers();
            clearUserForm();
            showNotification('Ajout√©!', 'success');
        }

        function clearUserForm() { document.getElementById('userForm').reset(); }
        
        function editUser(id) {
            if (!checkActionPermission('manage_users')) return;
            const user = users.find(u => u.id === id);
            if (user) {
                document.getElementById('newUserName').value = user.username;
                document.getElementById('newUserPassword').value = user.password;
                document.getElementById('newUserFullName').value = user.fullName;
                document.getElementById('newUserRole').value = user.role;
                deleteUser(id, false);
                showNotification('Modifiez puis sauvegardez.', 'info');
            }
        }

        async function deleteUser(id, notify = true) {
            if (!checkActionPermission('manage_users')) return;
            if (id === currentUser.id) { showNotification('Impossible de supprimer votre compte!', 'error'); return; }
            users = users.filter(u => u.id !== id);
            await saveData();
            loadUsers();
            if (notify) showNotification('Supprim√©!', 'success');
        }

        function backupDatabase() {
            if (!checkActionPermission('backup_database')) return;
            const data = JSON.stringify({ users, warehouses, drivers, operations, history });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(new Blob([data], { type: 'application/json' }));
            link.download = `backup_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
        }

        function restoreDatabase() {
            if (!checkActionPermission('restore_database')) return;
            const input = document.createElement('input');
            input.type = 'file'; input.accept = '.json';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        if(data.users) users = data.users;
                        if(data.warehouses) warehouses = data.warehouses;
                        if(data.drivers) drivers = data.drivers;
                        if(data.operations) operations = data.operations;
                        saveData();
                        location.reload();
                    } catch(err) { showNotification('Fichier invalide', 'error'); }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        async function resetDatabase() {
            if (!checkActionPermission('reset_database')) return;
            if (confirm('Tout supprimer ?')) {
                warehouses = []; drivers = []; operations = []; history = [];
                await saveData();
                location.reload();
            }
        }

        document.onkeydown = function(e) {
            if(e.keyCode == 123) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'I'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'C'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.shiftKey && e.keyCode == 'J'.charCodeAt(0)) return false;
            if(e.ctrlKey && e.keyCode == 'U'.charCodeAt(0)) return false;
        }
    </script>
</body>
</html>